name: Brahmi Keyboard CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
  # STAGE 1: Build APKs
  build-apks:
    name: Build APKs
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        project: [android-fdroid, android-googleplay]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Build Debug APK
      run: |
        cd ${{ matrix.project }}
        echo "ðŸ—ï¸ Building ${{ matrix.project }} debug APK..."
        ./gradlew clean assembleDebug --no-daemon --stacktrace
        
    - name: Debug Build Outputs
      run: |
        cd ${{ matrix.project }}
        echo "ðŸ” Debugging build outputs for ${{ matrix.project }}..."
        
        # Check if build directory exists
        echo "ðŸ“ Build directory exists: $(if [ -d "app/build" ]; then echo "YES"; else echo "NO"; fi)"
        
        # List all files in build directory
        echo "ðŸ“‹ Build directory contents:"
        find app/build -type f 2>/dev/null | head -20 || echo "No files in build directory"
        
        # Check outputs directory specifically
        echo "ðŸ“‚ Outputs directory:"
        if [ -d "app/build/outputs" ]; then
          find app/build/outputs -type f 2>/dev/null | head -20 || echo "No files in outputs"
        else
          echo "âŒ outputs directory doesn't exist!"
        fi
        
        # Search everywhere for APKs
        echo "ðŸ”Ž Searching for APK files everywhere..."
        find . -name "*.apk" -type f 2>/dev/null | while read apk; do
          echo "âœ… FOUND APK: $apk ($(ls -lh "$apk" | awk '{print $5}'))"
        done || echo "âŒ No APK files found anywhere"
        
    - name: Upload APK Artifact (Conditional)
      if: always()  # This is key - run even if previous steps fail
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ matrix.project }}-debug
        path: |
          ${{ matrix.project }}/app/build/outputs/apk/
          ${{ matrix.project }}/app/build/outputs/bundle/
        retention-days: 7

  # STAGE 2: Validation (Runs in parallel)
  validation:
    name: Project Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Make scripts executable
      run: |
        chmod +x .github/scripts/*.sh
        
    - name: Validate Project Structure
      run: |
        .github/scripts/test_project_structure.sh || echo "âš ï¸ Structure issues found"
        
    - name: Validate Android Manifest
      run: |
        .github/scripts/test_manifest_integrity.sh || echo "âš ï¸ Manifest issues found"
        
    - name: Validate Resources
      run: |
        .github/scripts/test_resources.sh || echo "âš ï¸ Resource issues found"

  # STAGE 3: Final Summary
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [build-apks, validation]
    if: always()
    
    steps:
    - name: Generate Summary Report
      run: |
        echo "# ðŸš€ Brahmi Keyboard CI/CD Summary" > summary.md
        echo "" >> summary.md
        echo "**Workflow:** ${{ github.workflow }}" >> summary.md
        echo "**Run:** ${{ github.run_id }}" >> summary.md
        echo "" >> summary.md
        
        echo "## ðŸ“Š Build Results" >> summary.md
        echo "- **F-Droid:** ${{ needs.build-apks.result }}" >> summary.md
        echo "- **Google Play:** ${{ needs.build-apks.result }}" >> summary.md
        echo "- **Validation:** ${{ needs.validation.result }}" >> summary.md
        echo "" >> summary.md
        
        if [[ "${{ needs.build-apks.result }}" == "success" ]]; then
          echo "âœ… **Build completed**" >> summary.md
          echo "ðŸ“± Check Artifacts section for APK files" >> summary.md
        else
          echo "âŒ **Build failed or no APKs generated**" >> summary.md
          echo "" >> summary.md
          echo "### ðŸ”§ Debug Steps:" >> summary.md
          echo "1. Check build logs for compilation errors" >> summary.md
          echo "2. Verify build.gradle.kts configuration" >> summary.md
          echo "3. Check for missing dependencies" >> summary.md
          echo "4. Look for duplicate file conflicts" >> summary.md
        fi
        
    - name: Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: ci-cd-summary
        path: summary.md
