name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-googleplay:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build Google Play
      run: |
        cd android-googleplay
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace --no-daemon
        
    - name: Run Google Play Tests
      run: |
        cd android-googleplay
        ./gradlew testDebugUnitTest --stacktrace --no-daemon
        
    - name: Lint Google Play
      run: |
        cd android-googleplay
        ./gradlew lintDebug --stacktrace --no-daemon || echo "Lint completed with warnings"
        
    - name: Upload Google Play APK
      uses: actions/upload-artifact@v4
      with:
        name: googleplay-apk
        path: android-googleplay/app/build/outputs/apk/debug/
        retention-days: 7

  build-fdroid:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build F-Droid
      run: |
        cd android-fdroid
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace --no-daemon
        
    - name: Run F-Droid Tests
      run: |
        cd android-fdroid
        ./gradlew testDebugUnitTest --stacktrace --no-daemon
        
    - name: Lint F-Droid
      run: |
        cd android-fdroid
        ./gradlew lintDebug --stacktrace --no-daemon || echo "Lint completed with warnings"
        
    - name: Upload F-Droid APK
      uses: actions/upload-artifact@v4
      with:
        name: fdroid-apk
        path: android-fdroid/app/build/outputs/apk/debug/
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Basic IME Check
      run: |
        echo "üîç Basic IME configuration check..."
        
        # Check if critical elements exist
        if grep -q "BrahmiInputMethodService" android-fdroid/app/src/main/AndroidManifest.xml; then
          echo "‚úÖ F-Droid has IME service"
        else
          echo "‚ùå F-Droid missing IME service"
          exit 1
        fi
        
        if grep -q "BrahmiInputMethodService" android-googleplay/app/src/main/AndroidManifest.xml; then
          echo "‚úÖ Google Play has IME service" 
        else
          echo "‚ùå Google Play missing IME service"
          exit 1
        fi
        
        # Check if method.xml exists
        if [ -f "android-fdroid/app/src/main/res/xml/method.xml" ]; then
          echo "‚úÖ F-Droid has method.xml"
        else
          echo "‚ùå F-Droid missing method.xml"
          exit 1
        fi
        
        if [ -f "android-googleplay/app/src/main/res/xml/method.xml" ]; then
          echo "‚úÖ Google Play has method.xml"
        else
          echo "‚ùå Google Play missing method.xml"
          exit 1
        fi
        
        echo "‚úÖ Basic IME configuration is present"

  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Check dependencies
      run: |
        echo "üì¶ Checking project dependencies..."
        
        cd android-fdroid
        ./gradlew app:dependencies --configuration debugCompileClasspath > fdroid-dependencies.txt || echo "Dependencies exported with warnings"
        echo "‚úÖ F-Droid dependencies exported"
        
        cd ../android-googleplay
        ./gradlew app:dependencies --configuration debugCompileClasspath > googleplay-dependencies.txt || echo "Dependencies exported with warnings"
        echo "‚úÖ Google Play dependencies exported"
        
    - name: Upload Dependency Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          android-fdroid/fdroid-dependencies.txt
          android-googleplay/googleplay-dependencies.txt
        retention-days: 7

# ADD THESE TWO JOBS TO YOUR EXISTING ci.yml:

  apk-validation:
    runs-on: ubuntu-latest
    needs: [build-googleplay, build-fdroid]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download APKs
      uses: actions/download-artifact@v4
      with:
        name: googleplay-apk
        path: artifacts/googleplay
      
    - name: Download F-Droid APKs  
      uses: actions/download-artifact@v4
      with:
        name: fdroid-apk
        path: artifacts/fdroid
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Run APK Validation Script
      run: |
        echo "üîç Running APK Validation..."
        chmod +x .github/scripts/validate_apk.sh
        
        # Validate Google Play APK
        GP_APK=$(find artifacts/googleplay -name "*.apk" | head -1)
        if [ -n "$GP_APK" ]; then
          echo "--- Validating Google Play ---"
          .github/scripts/validate_apk.sh "$GP_APK"
        fi
        
        # Validate F-Droid APK
        FD_APK=$(find artifacts/fdroid -name "*.apk" | head -1)
        if [ -n "$FD_APK" ]; then
          echo "--- Validating F-Droid ---"
          .github/scripts/validate_apk.sh "$FD_APK"
        fi

  final-report:
    runs-on: ubuntu-latest
    needs: [apk-validation, static-analysis, dependency-check]
    steps:
    - name: Generate Build Report
      run: |
        echo "üéâ BUILD SUMMARY"
        echo "‚úÖ All jobs completed successfully"
        echo "üì¶ APKs validated and ready"
        echo "üîç Static analysis passed"
        echo "üìä Dependencies checked"



