name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-googleplay:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build Google Play
      run: |
        cd android-googleplay
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace --no-daemon
        
    - name: Run Google Play Tests
      run: |
        cd android-googleplay
        ./gradlew testDebugUnitTest --stacktrace --no-daemon
        
    - name: Lint Google Play
      run: |
        cd android-googleplay
        ./gradlew lintDebug --stacktrace --no-daemon || echo "Lint completed with warnings"
        
    - name: Upload Google Play APK
      uses: actions/upload-artifact@v4
      with:
        name: googleplay-apk
        path: android-googleplay/app/build/outputs/apk/debug/
        retention-days: 7

  build-fdroid:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build F-Droid
      run: |
        cd android-fdroid
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace --no-daemon
        
    - name: Run F-Droid Tests
      run: |
        cd android-fdroid
        ./gradlew testDebugUnitTest --stacktrace --no-daemon
        
    - name: Lint F-Droid
      run: |
        cd android-fdroid
        ./gradlew lintDebug --stacktrace --no-daemon || echo "Lint completed with warnings"
        
    - name: Upload F-Droid APK
      uses: actions/upload-artifact@v4
      with:
        name: fdroid-apk
        path: android-fdroid/app/build/outputs/apk/debug/
        retention-days: 7

  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Basic IME Check
      run: |
        echo "ðŸ” Basic IME configuration check..."
        
        # Check if critical elements exist
        if grep -q "BrahmiInputMethodService" android-fdroid/app/src/main/AndroidManifest.xml; then
          echo "âœ… F-Droid has IME service"
        else
          echo "âŒ F-Droid missing IME service"
          exit 1
        fi
        
        if grep -q "BrahmiInputMethodService" android-googleplay/app/src/main/AndroidManifest.xml; then
          echo "âœ… Google Play has IME service" 
        else
          echo "âŒ Google Play missing IME service"
          exit 1
        fi
        
        # Check if method.xml exists
        if [ -f "android-fdroid/app/src/main/res/xml/method.xml" ]; then
          echo "âœ… F-Droid has method.xml"
        else
          echo "âŒ F-Droid missing method.xml"
          exit 1
        fi
        
        if [ -f "android-googleplay/app/src/main/res/xml/method.xml" ]; then
          echo "âœ… Google Play has method.xml"
        else
          echo "âŒ Google Play missing method.xml"
          exit 1
        fi
        
        echo "âœ… Basic IME configuration is present"

  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Check dependencies
      run: |
        echo "ðŸ“¦ Checking project dependencies..."
        
        cd android-fdroid
        ./gradlew app:dependencies --configuration debugCompileClasspath > fdroid-dependencies.txt || echo "Dependencies exported with warnings"
        echo "âœ… F-Droid dependencies exported"
        
        cd ../android-googleplay
        ./gradlew app:dependencies --configuration debugCompileClasspath > googleplay-dependencies.txt || echo "Dependencies exported with warnings"
        echo "âœ… Google Play dependencies exported"
        
    - name: Upload Dependency Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          android-fdroid/fdroid-dependencies.txt
          android-googleplay/googleplay-dependencies.txt
        retention-days: 7
